<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SECI Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="./js/main.js"></script>
    <style>
      body {
        font-family: "Roboto", sans-serif;
        font-size: 30px;
        margin: 0;
      }

      .top-bar {
        background-color: #f8f9fa;
        padding: 10px 20px;
        border-bottom: 1px solid #ddd;
      }

      .main-wrapper {
        display: flex;
        height: calc(100vh - 60px);
      }

      .tab-sidebar {
        width: 220px;
        border-right: 1px solid #ddd;
        padding: 15px;
        overflow-y: auto;
      }

      .tab-content-area {
        flex-grow: 1;
        padding: 20px;
        overflow-y: auto;
      }

      .tab-button {
        text-align: left;
        width: 100%;
        margin-bottom: 10px;
      }

      .tab-button.active {
        background-color: #e9ecef;
        font-weight: bold;
      }

      .main-wrapper {
        display: flex;
        flex-wrap: nowrap; /* <-- ensure it doesn't wrap */
        height: calc(100vh - 60px);
        overflow: hidden;
      }

      .breadcrumb-label {
        font-size: 1rem;
        font-weight: 500;
        color: #555;
      }

      .tab-sidebar {
        width: 220px;
        min-width: 220px;
        max-width: 220px;
        flex-shrink: 0;
      }

      .small-text-muted {
        font-size: 0.85rem;
        color: #888;
      }

      .table {
        font-size: 13px;
        border-radius: 8px;
        overflow: hidden;
      }

      .main-header {
        background: linear-gradient(90deg, #ffffff, #99b6e2);
        color: #fff;
        font-size: 14px;
        letter-spacing: 0.3px;
      }

      .solar-header {
        background: linear-gradient(180deg, #fff3cd, #ffe69c);
        color: #664d03;
        border-color: #ffda6a;
      }

      .bess-header {
        background: linear-gradient(180deg, #d1e7dd, #a3cfbb);
        color: #0f5132;
        border-color: #75b798;
      }

      .logo-cell {
        background: linear-gradient(180deg, #ffffff, #f1f4f9);
        border-right: 2px solid #dee2e6;
        text-align: center;
      }

      .logo-cell img {
        filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.1));
      }

      .table tbody tr:nth-child(even) {
        background-color: #f9fbff;
      }

      .table tbody tr:hover {
        background-color: #eef5ff;
        transition: background 0.2s ease-in-out;
      }

      .table tbody td {
        text-align: center;
        vertical-align: middle;
      }

      .site-cell {
        text-align: left !important;
        font-weight: 600;
        background: linear-gradient(180deg, #f8f9fa, #eef1f5);
        color: #0d6efd;
      }

      tbody td:nth-child(2),
      tbody td:nth-child(3),
      tbody td:nth-child(4),
      tbody td:nth-child(5),
      tbody td:nth-child(6),
      tbody td:nth-child(7),
      tbody td:nth-child(8),
      tbody td:nth-child(9),
      tbody td:nth-child(10) {
        background-color: #fff9e6;
      }

      tbody td:nth-child(11),
      tbody td:nth-child(12),
      tbody td:nth-child(13),
      tbody td:nth-child(14),
      tbody td:nth-child(15),
      tbody td:nth-child(16) {
        background-color: #eaf7f1;
      }

      tbody td:last-child {
        font-weight: 600;
        color: #495057;
      }

      tbody td:last-child:not(:empty) {
        background: #e7f1ff;
        border-left: 3px solid #0b5ed7;
      }

      .note {
        font-size: 12px;
        color: #495057;
        background: #ffffff;
        padding: 8px 12px;
        border-left: 4px solid #0b5ed7;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <!-- üîπ Top Bar -->
    <div
      class="top-bar d-flex justify-content-between align-items-center px-4 py-2 border-bottom bg-light"
    >
      <div class="d-flex align-items-center gap-3">
        <img
          src="https://www.seci.co.in/frontend/assets/images/seci-logo.png"
          alt="SECI Logo"
          style="height: 40px; width: auto"
        />
        <div class="breadcrumb-label" id="breadcrumb">
          Projects Dashboard > Home
        </div>
      </div>
      <div id="topRight" class="d-flex align-items-center gap-3">
        <span id="userName" class="small-text-muted">Welcome, User</span>
      </div>
    </div>

    <!-- üîπ Main Content Area -->
    <div class="main-wrapper">
      <div class="tab-sidebar">
        <h5>Departments</h5>
        <div id="sidebarButtons"></div>
      </div>

      <div class="tab-content-area">
        <div id="departmentContent" class="mt-4"></div>
      </div>
    </div>

    <script>
      Chart.register({
        id: "centerText",
        beforeDraw(chart) {
          //skip middle text for some departments

          const centerConfig = chart.config.options.elements?.center;
          if (!centerConfig) return; // ‚õîÔ∏è exit if center config is missing

          const ctx = chart.ctx;
          const { text, color, fontStyle, minFontSize } = centerConfig;

          const fontSize = minFontSize || 16;
          const centerX = (chart.chartArea.left + chart.chartArea.right) / 2;
          const centerY = (chart.chartArea.top + chart.chartArea.bottom) / 2;

          ctx.save();
          ctx.font = `${
            fontStyle || "bold"
          } ${fontSize}px Roboto, Arial, sans-serif`;
          ctx.fillStyle = color || "#000";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillText(text, centerX, centerY);
          ctx.restore();
        },
      });

      const jwt_token = localStorage.getItem("token");
      const parsedToken = JSON.parse(atob(jwt_token.split(".")[1]));
      const userName = parsedToken.name || "User";
      const role = parsedToken.role || "user";
      const user_id = parsedToken.user_id || "unknown";
      document.getElementById("userName").textContent = `Welcome, ${userName}`;

      const pptMetaData = [
        {
          name: "Wind Presentation",
          thumbnail:
            "https://img.freepik.com/free-photo/silhouette-windmills-field-sunset_181624-27593.jpg?t=st=1758179951~exp=1758183551~hmac=a310e3066a261d67febf8d6c3864a5a33c887480fe89ab94341c3a248448c9af&w=740",
          type: "wind",
        },
        {
          name: "Hybrid Presentation",
          thumbnail:
            "https://img.freepik.com/free-photo/3d-electric-car-parked_23-2148972406.jpg?t=st=1758180360~exp=1758183960~hmac=37f90d9838058a4f9a1889fa1785e0778745e9d14d03284f1a00a5b8fa830c65&w=740",
          type: "hybrid",
        },
        {
          name: "Data",
          thumbnail:
            "https://img.freepik.com/premium-photo/businessman-working-with-data-management-system-computer-make-report-with-kpi-metrics-connected-database-finance-operations-sales-marketing-kpi-business-performance-indicators_568137-1291.jpg?w=740",
          type: "data",
        },
      ];

      const breadcrumb = document.getElementById("breadcrumb");
      const topRight = document.getElementById("topRight");

      if (role === "admin") {
        const settingsBtn = document.createElement("button");
        settingsBtn.className = "btn btn-success btn-sm";
        settingsBtn.innerHTML = '<i class="bi bi-lock"></i> Admin Panel';
        settingsBtn.onclick = () => {
          window.location.href = "/settings.html";
        };
        topRight.appendChild(settingsBtn);
      }

      if (localStorage.getItem("app_environment") == "TESTING") {
        const appEnvironemntBtn = document.createElement("button");
        appEnvironemntBtn.className = "btn btn-warning btn-sm";
        appEnvironemntBtn.innerHTML = "TESTING";
        topRight.appendChild(appEnvironemntBtn);
      }

      const infoBtn = document.createElement("button");
      infoBtn.className = "btn btn-info btn-sm";
      infoBtn.innerHTML = '<i class="bi bi-question"></i>';
      infoBtn.onclick = () => {
        window.location.href = "/info.html";
      };
      topRight.appendChild(infoBtn);

      const logoutBtn = document.createElement("button");
      logoutBtn.className = "btn btn-danger btn-sm";
      logoutBtn.innerHTML = '<i class="bi bi-box-arrow-right"></i> Logout';
      logoutBtn.onclick = () => {
        localStorage.clear();
        window.location.href = "/";
      };
      topRight.appendChild(logoutBtn);

      const departments = [
        {
          dept_name: "Home",
        },
      ];
      const departmentStatistics = {};
      const departmentStatisticEntities = [];
      const departmentStatisticEntityFields = [];
      let businessDevelopmentData = [];

      const icons = [
        "bi-house",
        "bi-briefcase",
        "bi-building",
        "bi-gear",
        "bi-lightning",
      ];

      function authFetch(url, options = {}) {
        const token = localStorage.getItem("token");
        const defaultHeaders = {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        };

        return fetch(url, {
          ...options,
          headers: {
            ...defaultHeaders,
            ...(options.headers || {}),
          },
        }).then((res) => {
          if (res.status === 401) {
            alert("Session expired. Redirecting to login...");
            localStorage.clear();
            window.location.href = "/";
            throw new Error("Unauthorized");
          }
          return res;
        });
      }

      function formatDate(dateString) {
        const date = new Date(dateString);

        const day = String(date.getDate()).padStart(2, "0"); // dd
        const month = String(date.getMonth() + 1).padStart(2, "0"); // mm (months are 0-indexed)
        const year = date.getFullYear(); // yyyy

        return `${day}-${month}-${year}`;
      }

      async function fetchDepartments() {
        try {
          //clear each of these to avoid duplicate entries
          departments.length = 1;
          departmentStatisticEntities.length = 0;
          departmentStatisticEntityFields.length = 0;

          for (const key in departmentStatistics) {
            delete departmentStatistics[key];
          }

          //fetch api data
          const res = await authFetch(`/api/data/departments/user/${user_id}`);
          const departmentsObject = await res.json();
          const departmentList = departmentsObject.departments || [];
          // get details for all apartments for which user has access to
          for (const dept_id of departmentList) {
            const departmentResponse = await authFetch(
              `/api/data/departments/${dept_id}`
            );
            const departmentDetails = await departmentResponse.json();
            // console.log(departmentDetails);
            departments.push({
              dept_id: departmentDetails.dept_id,
              dept_name: departmentDetails.dept_name,
              yp_count: departmentDetails.yp_count,
              regular_count: departmentDetails.regular_count,
              contractual_count: departmentDetails.contractual_count,
            });
            if (departmentDetails.dept_name === "Business Development") {
              const bdResponse = await authFetch(`/api/data/bd/entry/all`);
              const bdJSON = await bdResponse.json();
              const bdData = bdJSON.data;
              businessDevelopmentData = bdData.reduce((acc, entry) => {
                acc[entry.business_partner] = entry.anticipated_capacity;
                return acc;
              }, {});
              // console.log(businessDevelopmentData);
            }
            //get department statistics and show them here
            const statsResponse = await authFetch(
              `/api/data/statistics/${dept_id}`
            );
            const statsData = await statsResponse.json();
            //stores the statistics for each department
            departmentStatistics[dept_id] = statsData;
            for (const stat of statsData) {
              //get the entities for each statistic for each department
              const stat_id = stat.statistic_id;
              const entitiesResponse = await authFetch(
                `/api/data/entities/${dept_id}/${stat_id}`
              );
              const tempEntityResponse = await entitiesResponse.json();
              const seenEntityKeys = new Set();

              for (const entity of tempEntityResponse) {
                const key = `${dept_id}-${stat_id}-${entity.entity_id}`;
                if (seenEntityKeys.has(key)) continue;
                seenEntityKeys.add(key);

                departmentStatisticEntities.push({
                  dept_id: dept_id,
                  statistic_id: stat_id,
                  entity_id: entity.entity_id,
                  entity_name: entity.entity_name,
                  entity_value: entity.entity_value,
                });

                const departmentStatisticEntityFieldsResponse = await authFetch(
                  `/api/data/fields/${dept_id}/${stat_id}/${entity.entity_id}`
                );
                const departmentStatisticEntityFieldsArray =
                  await departmentStatisticEntityFieldsResponse.json();
                departmentStatisticEntityFieldsArray.forEach(
                  (departmentStatisticEntityField) => {
                    departmentStatisticEntityFields.push({
                      dept_id: dept_id,
                      statistic_id: stat_id,
                      entity_id: entity.entity_id,
                      entity_name: entity.entity_name,
                      entity_value: entity.entity_value,
                      field_name: departmentStatisticEntityField.field_name,
                      field_value: `${departmentStatisticEntityField.field_value}${departmentStatisticEntityField.field_unit}`,
                    });
                  }
                );
              }
            }
          }

          authFetch("/api/data/reia/documents/all").then(async (response) => {
            let data = await response.json();
            data = data.data;
            pptMetaData.forEach((ppt) => {
              const matchedData = data.find(
                (doc) => doc.reia_doc_type === ppt.type
              );
              if (matchedData) {
                ppt.reia_doc_path = matchedData.reia_doc_path;
                ppt.last_updated_on = formatDate(matchedData.last_updated_on);
              }
            });
          });
          // console.log(departmentStatisticEntityFields);
          renderSidebar();
        } catch (err) {
          console.error("Error fetching departments:", err.message);
        }
      }

      function renderSidebar() {
        const sidebar = document.getElementById("sidebarButtons");
        sidebar.innerHTML = "";
        departments.forEach((dept, i) => {
          const button = document.createElement("button");
          button.className = `btn tab-button ${i === 0 ? "active" : ""}`;
          button.setAttribute("data-index", i);
          button.innerHTML = `<i class="bi ${
            icons[i % icons.length]
          } me-2"></i> <span class="tab-text">${dept.dept_name}</span>`;
          button.addEventListener("click", () => switchDepartment(i));
          sidebar.appendChild(button);
        });
        switchDepartment(0);
      }

      function updateREIAInfo(type) {
        console.log(`/update_reia_info.html?reia_doc_type=${type}`);
        window.location.href = `/update_reia_info.html?reia_doc_type=${type}`;
      }

      function switchDepartment(index) {
        const allButtons = document.querySelectorAll(".tab-button");
        allButtons.forEach((btn) => {
          const idx = parseInt(btn.getAttribute("data-index"));
          btn.classList.toggle("active", idx === index);
        });

        const dept = departments[index];
        // console.log(departmentStatistics);
        if (dept.dept_name === "REIA") {
          //PPT shown here
          document.getElementById("departmentContent").innerHTML = `
        <div class="container-fluid">
          <h3 class="mb-4"><b>REIA Details</b></h3>
          <div class="row row-cols-1 row-cols-sm-2 row-cols-md-4 g-4" id="pptGrid">
          </div>
        </div>
      `;

          // Example: data from API (mocked here)

          const pptGrid = document.getElementById("pptGrid");

          pptMetaData.forEach((ppt) => {
            pptGrid.innerHTML += `
            <div class="col">
              <div class="card h-100 shadow-sm border-0">
                <img src="${ppt.thumbnail}" class="card-img-top" alt="${ppt.name}"
                    style="height:180px; object-fit:cover;">
                <div class="card-body text-center">
                  <p class="card-title mb-1">${ppt.name}</h6>
                  <h6 class="text-muted small mb-0">Updated on: ${ppt.last_updated_on}</p>
                <a href='${ppt.reia_doc_path}'>Download</a>
                    <button  class="btn btn-sm btn-outline-secondary" onclick="updateREIAInfo('${ppt.type}')"> Update Info </button>
                    </div>
              </div>
            </div>
          `;
          });
        } else if (dept.dept_name === "Business Development") {
          const labels = Object.keys(businessDevelopmentData);
          const dataValues = Object.values(businessDevelopmentData).map(
            (value) => parseFloat(value)
          );
          document.getElementById("departmentContent").innerHTML = `
                    <h3><b>${dept.dept_name}</b></h3>

                        <div class="d-flex flex-wrap small text-muted mt-2 align-items-center">
                          <span class="me-3">
                            <i class="bi bi-people-fill me-1"></i>
                            <strong>Total Headcount:</strong> ${
                              dept.yp_count +
                              dept.regular_count +
                              dept.contractual_count
                            }
                          </span>
                          <span class="me-3">
                            <i class="bi bi-person-badge me-1"></i>
                            <strong>Regular:</strong> ${dept.regular_count}
                          </span>
                          <span class="me-3">
                            <i class="bi bi-person-workspace me-1"></i>
                            <strong>YP:</strong> ${dept.yp_count}
                          </span>
                          <span class="me-3">
                            <i class="bi bi-person-lines-fill me-1"></i>
                            <strong>Contractual:</strong> ${
                              dept.contractual_count
                            }
                          </span>
                          <button class="btn btn-sm btn-outline-secondary" onclick="editHeadcount(${index})">
                            <i class="bi bi-pencil-square me-1"></i> Edit Headcount
                          </button>
                        </div>
                        <br/>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <h3 class="mb-0"><b>Key Issues/Targets</b></h3>


                        </div>
                        <div id="chartsContainer" class="row mt-4"></div>
                      `;

          // char code start
          const chartsContainer = document.getElementById("chartsContainer");
          chartsContainer.innerHTML = "";
          //filter entities
          const chartWrapper = document.createElement("div");
          const entityLabels = labels;
          const entityIds = dataValues;
          // console.log("filetered entities", filteredEntityFields);
          chartWrapper.className = "col-12 d-flex justify-content-center mb-4";
          chartWrapper.innerHTML = `
                        <div class="card" style="height: 800px; width: 1500px; margin: auto;>
                          <div class="card-body">
                            <h2 class="card-title text-center"><b>Proposals</b></h6>
                            <div ">
                              <canvas id="bd-chart" width="600" height="400"  style="display: block; margin: auto;"></canvas>
                            </div>
                            <div class="text-center mt-3 d-flex flex-wrap justify-content-center gap-2">
                            </div>
                          </div>
                        </div>
                      `;

          chartsContainer.appendChild(chartWrapper);

          const entityValues = dataValues;
          const totalValue = entityValues.reduce((sum, val) => sum + val, 0);
          console.log(`bd total: ${typeof dataValues[0]}`);
          const entityFields = labels;

          const chartInstance = new Chart(document.getElementById("bd-chart"), {
            type: "doughnut",
            data: {
              labels: entityLabels,
              datasets: [
                {
                  data: entityValues,
                  backgroundColor: [
                    "#007bff",
                    "#28a745",
                    "#ffc107",
                    "#dc3545",
                    "#6610f2",
                    "#fd7e14",
                  ],
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: {
                  display: false,
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      const index = context.dataIndex;
                      const entity_id = relatedEntities[index].entity_id;
                      const matchingFields = filteredEntityFields.filter(
                        (f) => f.entity_id === entity_id
                      );

                      const lines = [
                        `${relatedEntities[index].entity_name}: ${relatedEntities[index].entity_value}`,
                      ];
                      matchingFields.forEach((field) => {
                        lines.push(`${field.field_name}: ${field.field_value}`);
                      });
                      return lines;
                    },
                  },
                },
              },
              elements: {
                center: {
                  text: `${totalValue.toString()} MW`, // üëà this shows the total in center
                  color: "#333",
                  minFontSize: 20,
                  lineHeight: 25,
                },
              },
              onClick: (evt, activeEls, chart) => {
                window.location.href = "/business_development_external.html";
              },
            },
          });

          chartInstance.dept_id = dept.dept_id;
          chartInstance.dept_name = dept.dept_name;
          chartInstance.statistic_id = stat.statistic_id;
          chartInstance.relatedEntities = relatedEntities;
        } else if (dept.dept_name !== "Home") {
          document.getElementById("departmentContent").innerHTML = `
                    <h3><b>${dept.dept_name}</b></h3>

                        <div class="d-flex flex-wrap small text-muted mt-2 align-items-center">
                          <span class="me-3">
                            <i class="bi bi-people-fill me-1"></i>
                            <strong>Total Headcount:</strong> ${
                              dept.yp_count +
                              dept.regular_count +
                              dept.contractual_count
                            }
                          </span>
                          <span class="me-3">
                            <i class="bi bi-person-badge me-1"></i>
                            <strong>Regular:</strong> ${dept.regular_count}
                          </span>
                          <span class="me-3">
                            <i class="bi bi-person-workspace me-1"></i>
                            <strong>YP:</strong> ${dept.yp_count}
                          </span>
                          <span class="me-3">
                            <i class="bi bi-person-lines-fill me-1"></i>
                            <strong>Contractual:</strong> ${
                              dept.contractual_count
                            }
                          </span>
                          <button class="btn btn-sm btn-outline-secondary" onclick="editHeadcount(${index})">
                            <i class="bi bi-pencil-square me-1"></i> Edit Headcount
                          </button>
                        </div>
                        <br/>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <h3 class="mb-0"><b>Key Issues/Targets</b></h3>
                        </div>
                        <div id="chartsContainer" class="row mt-4"></div>
                        <div class="container-fluid mt-4">

  <div class="table-responsive">
    <table class="table table-bordered table-hover bg-white">

      <thead>
        <!-- Title Row with Logo -->
        <tr>
          <th class="logo-cell" rowspan="3" style="width:220px;">
            <img src="assets/seci-logo.png" alt="SECI Logo" class="img-fluid mb-2" style="max-height:50px;">
            <div class="fw-bold text-primary">SECI O&amp;M<br>Generation Data</div>
            <div class="small text-muted">Date: 12 Jan 2026</div>
          </th>

          <th class="main-header" colspan="16">
            Operational Performance Summary
          </th>

        </tr>

        <!-- Group Headers -->
        <tr>
          <th class="solar-header" colspan="9">SOLAR PERFORMANCE</th>
          <th class="bess-header" colspan="6">BESS PERFORMANCE</th>
          <th rowspan="2">Remarks</th>
        </tr>

        <!-- Column Headers -->
        <tr>
          <!-- Solar -->
          <th class="solar-header">GHI<br>(kWh/m¬≤)</th>
          <th class="solar-header">Exported<br>Gen (MU)</th>
          <th class="solar-header">CUF<br>(%)</th>
          <th class="solar-header">Peak<br>Power (MW)</th>

          <th class="solar-header">YTD Gen<br>(MU)</th>
          <th class="solar-header">YTD CUF<br>(%)</th>

          <th class="solar-header">Last FY Gen<br>(MU)</th>
          <th class="solar-header">Last FY CUF<br>(%)</th>
          <th class="solar-header">Last FY Peak<br>(MW)</th>

          <!-- BESS -->
          <th class="bess-header">Net Export<br>(MWh)</th>
          <th class="bess-header">Net Import<br>(MWh)</th>

          <th class="bess-header">YTD Export<br>(MWh)</th>
          <th class="bess-header">YTD Import<br>(MWh)</th>

          <th class="bess-header">Last FY Export<br>(MWh)</th>
          <th class="bess-header">Energy FED<br>(MWh)</th>
        </tr>
      </thead>

      <tbody>
  <!-- 1 -->
  <tr>
    <td class="site-cell">
      Solar Project ‚Äì 50 MW<br>
      <span class="text-muted small">Bhadla, Rajasthan</span>
    </td>
    <td>5.62</td>
    <td>0.21</td>
    <td>19.4</td>
    <td>42</td>
    <td>612</td>
    <td>20.1</td>
    <td>985</td>
    <td>21.3</td>
    <td>48</td>
    <td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>
    <td>-</td>
  </tr>

  <!-- 2 -->
  <tr>
    <td class="site-cell">
      Solar Project ‚Äì 100 MW<br>
      <span class="text-muted small">Pavagada, Karnataka</span>
    </td>
    <td>5.11</td>
    <td>0.39</td>
    <td>22.1</td>
    <td>88</td>
    <td>1,182</td>
    <td>22.6</td>
    <td>1,940</td>
    <td>23.4</td>
    <td>96</td>
    <td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>
    <td>-</td>
  </tr>

  <!-- 3 -->
  <tr>
    <td class="site-cell">
      BESS Project ‚Äì 20 MW / 80 MWh<br>
      <span class="text-muted small">Leh, Ladakh</span>
    </td>
    <td>-</td><td>-</td><td>-</td><td>-</td>
    <td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>
    <td>12</td>
    <td>14</td>
    <td>2,140</td>
    <td>2,215</td>
    <td>3,620</td>
    <td>11</td>
    <td>Peak support</td>
  </tr>

  <!-- 4 -->
  <tr>
    <td class="site-cell">
      Solar + BESS ‚Äì 50 MW + 20 MW / 60 MWh<br>
      <span class="text-muted small">Anantapur, AP</span>
    </td>
    <td>5.48</td>
    <td>0.24</td>
    <td>21.8</td>
    <td>46</td>
    <td>658</td>
    <td>22.3</td>
    <td>1,012</td>
    <td>23.0</td>
    <td>52</td>
    <td>15</td>
    <td>14</td>
    <td>1,890</td>
    <td>1,845</td>
    <td>3,120</td>
    <td>13</td>
    <td>Normal</td>
  </tr>

  <!-- 5 -->
  <tr>
    <td class="site-cell">
      Solar Project ‚Äì 75 MW<br>
      <span class="text-muted small">Rewa, MP</span>
    </td>
    <td>5.32</td>
    <td>0.29</td>
    <td>20.9</td>
    <td>66</td>
    <td>895</td>
    <td>21.4</td>
    <td>1,420</td>
    <td>22.1</td>
    <td>71</td>
    <td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>
    <td>-</td>
  </tr>

  <!-- 6 -->
  <tr>
    <td class="site-cell">
      BESS Project ‚Äì 40 MW / 120 MWh<br>
      <span class="text-muted small">Delhi NCR</span>
    </td>
    <td>-</td><td>-</td><td>-</td><td>-</td>
    <td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>
    <td>28</td>
    <td>26</td>
    <td>4,310</td>
    <td>4,205</td>
    <td>6,980</td>
    <td>24</td>
    <td>Grid balancing</td>
  </tr>

  <!-- 7 -->
  <tr>
    <td class="site-cell">
      Solar + BESS ‚Äì 100 MW + 40 MW / 120 MWh<br>
      <span class="text-muted small">Rajnandgaon, CG</span>
    </td>
    <td>5.57</td>
    <td>0.43</td>
    <td>23.4</td>
    <td>92</td>
    <td>1,368</td>
    <td>24.1</td>
    <td>2,110</td>
    <td>24.8</td>
    <td>104</td>
    <td>32</td>
    <td>29</td>
    <td>4,820</td>
    <td>4,730</td>
    <td>7,240</td>
    <td>27</td>
    <td>Stable</td>
  </tr>

  <!-- 8 -->
  <tr>
    <td class="site-cell">
      Solar Project ‚Äì 200 MW<br>
      <span class="text-muted small">Khavda, Gujarat</span>
    </td>
    <td>5.74</td>
    <td>0.86</td>
    <td>24.6</td>
    <td>178</td>
    <td>2,950</td>
    <td>25.2</td>
    <td>4,610</td>
    <td>26.0</td>
    <td>192</td>
    <td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>
    <td>-</td>
  </tr>

  <!-- 9 -->
  <tr>
    <td class="site-cell">
      Solar + BESS ‚Äì 150 MW + 50 MW / 150 MWh<br>
      <span class="text-muted small">Jaisalmer, Rajasthan</span>
    </td>
    <td>5.69</td>
    <td>0.66</td>
    <td>24.1</td>
    <td>138</td>
    <td>2,240</td>
    <td>24.7</td>
    <td>3,580</td>
    <td>25.3</td>
    <td>151</td>
    <td>41</td>
    <td>38</td>
    <td>5,920</td>
    <td>5,810</td>
    <td>8,640</td>
    <td>35</td>
    <td>High solar day</td>
  </tr>

  <!-- 10 -->
  <tr>
    <td class="site-cell">
      BESS Project ‚Äì 10 MW / 40 MWh<br>
      <span class="text-muted small">Shillong, Meghalaya</span>
    </td>
    <td>-</td><td>-</td><td>-</td><td>-</td>
    <td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>
    <td>6</td>
    <td>7</td>
    <td>980</td>
    <td>1,015</td>
    <td>1,740</td>
    <td>5</td>
    <td>Low demand</td>
  </tr>
</tbody>

    </table>
  </div>

  <!-- Notes -->
  <div class="note mt-2">
    * Data is without considering radiation correction<br>
    ^ Data considered from 21st October
  </div>

</div>
                      `;
          const chartsContainer = document.getElementById("chartsContainer");
          chartsContainer.innerHTML = "";

          const deptStats = departmentStatistics[dept.dept_id];
          if (!deptStats || deptStats.length === 0) {
            document.getElementById(
              "departmentContent"
            ).innerHTML += `<p class="text-muted">No statistics available for this department.</p>`;
            return;
          }

          //filter entities
          deptStats.forEach((stat, i) => {
            const chartId = `chart-${index}-${i}`;
            const chartWrapper = document.createElement("div");
            const relatedEntities = departmentStatisticEntities.filter(
              (e) =>
                e.dept_id === dept.dept_id &&
                e.statistic_id === stat.statistic_id
            );
            const entityLabels = relatedEntities.map((e) => e.entity_name);
            const entityIds = relatedEntities.map((e) => e.entity_id);
            const filteredEntityFields = departmentStatisticEntityFields.filter(
              (f) =>
                f.dept_id === dept.dept_id &&
                f.statistic_id === stat.statistic_id &&
                entityIds.includes(f.entity_id)
            );

            // console.log("filetered entities", filteredEntityFields);
            chartWrapper.className =
              "col-12 d-flex justify-content-center mb-4";
            chartWrapper.innerHTML = `
                        <div class="card" style="height: 800px; width: 1500px; margin: auto;>
                          <div class="card-body">
                            <h2 class="card-title text-center"><b>${stat.statistic_name}</b></h6>
                            <div ">
                              <canvas id="${chartId}" width="600" height="400"  style="display: block; margin: auto;"></canvas>
                            </div>
                            <div class="text-center mt-3 d-flex flex-wrap justify-content-center gap-2">

                              <button class="btn btn-sm btn-outline-primary" onclick="editStatistic('${dept.dept_id}', '${stat.statistic_id}')">
                                <i class="bi bi-pencil"></i> Edit
                              </button>
                            </div>
                          </div>
                        </div>
                      `;

            chartsContainer.appendChild(chartWrapper);

            const entityValues = relatedEntities.map((e) => e.entity_value);
            const totalValue = entityValues.reduce((sum, val) => sum + val, 0);
            const entityFields = departmentStatisticEntityFields;

            const chartInstance = new Chart(document.getElementById(chartId), {
              type: "doughnut",
              data: {
                labels: entityLabels,
                datasets: [
                  {
                    data: entityValues,
                    backgroundColor: [
                      "#007bff",
                      "#28a745",
                      "#ffc107",
                      "#dc3545",
                      "#6610f2",
                      "#fd7e14",
                    ],
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                  legend: {
                    display: false,
                  },
                  tooltip: {
                    callbacks: {
                      label: function (context) {
                        const index = context.dataIndex;
                        const entity_id = relatedEntities[index].entity_id;
                        const matchingFields = filteredEntityFields.filter(
                          (f) => f.entity_id === entity_id
                        );

                        const lines = [
                          `${relatedEntities[index].entity_name}: ${relatedEntities[index].entity_value}`,
                        ];
                        matchingFields.forEach((field) => {
                          lines.push(
                            `${field.field_name}: ${field.field_value}`
                          );
                        });
                        return lines;
                      },
                    },
                  },
                },
                elements: {
                  center: {
                    text: `${totalValue.toString()} MW`, // üëà this shows the total in center
                    color: "#333",
                    minFontSize: 20,
                    lineHeight: 25,
                  },
                },
                onClick: (evt, activeEls, chart) => {
                  if (activeEls.length > 0) {
                    const index = activeEls[0].index; // Index of clicked segment
                    const entity = chart.relatedEntities[index];

                    const dept_id = chart.dept_id;
                    const dept_name = chart.dept_name;
                    const statistic_id = chart.statistic_id;
                    const entity_id = entity.entity_id;

                    // alert(dept_name); //this is needed to open different pages for each department
                    if (dept_name === "O&M") {
                      window.location.href = `/om_external.html?dept_id=${dept_id}&statistic_id=${statistic_id}&entity_id=${entity_id}`;
                    } else if (dept_name === "Contracts & Procurement") {
                      // alert(dept_name);
                      window.location.href = "/contracts_external.html";
                    } else if (dept_name == "Business Development") {
                      window.location.href =
                        "/business_development_external.html";
                    } else {
                      // "_self" makes it open in the same tab
                      window.open(
                        `/external.html?dept_id=${dept_id}&statistic_id=${statistic_id}&entity_id=${entity_id}`,
                        "_self"
                      );
                    }
                  }
                },
              },
            });

            chartInstance.dept_id = dept.dept_id;
            chartInstance.dept_name = dept.dept_name;
            chartInstance.statistic_id = stat.statistic_id;
            chartInstance.relatedEntities = relatedEntities;
          });
        } else {
          // This renders the chart on the home page
          // Prevent sidebar collapse by using a container-fluid for the grid
          let homeHtml = `<h3><b>Departments Overview</b></h3><div class="row">`;
          departments.slice(1).forEach((d) => {
            const stats = departmentStatistics[d.dept_id] || [];
            const homeStat = stats.find((s) => s.is_shown_on_home); // ‚úÖ find the one marked for home display
            const chartId = `home-chart-${d.dept_id}`;
            let chartCanvas = "";

            if (d.dept_name === "Business Development") {
              chartCanvas = `
                    <div style="height: 200px;">
                      <canvas id="${chartId}" width="500" height="500"  style="display: block; margin: auto;"></canvas>
                    </div>
                  `;
            } else {
              chartCanvas = `
                    <div style="height: 200px;">
                      <canvas id="${chartId}" width="500" height="500"  style="display: block; margin: auto;"></canvas>
                    </div>
                  `;
            }

            const deptIndex = departments.findIndex(
              (dep) => dep.dept_id === d.dept_id
            );

            homeHtml += `
                      <div class="col-md-6 mb-4">
                        <div class="card h-100 clickable-card" onclick="switchDepartment(${deptIndex})" style="cursor: pointer;">
                          <div class="card-body">
                            <h5 class="card-title">${d.dept_name}</h5>
                            ${chartCanvas}
                            <br/>
                          </div>
                        </div>
                      </div>
                    `;
            const relatedEntities = departmentStatisticEntities.filter(
              (e) =>
                e.dept_id === d.dept_id &&
                e.statistic_id === homeStat.statistic_id
            );

            let entityLabels = [];
            let entityValues = [];
            if (d.dept_name == "Business Development") {
              entityLabels = Object.keys(businessDevelopmentData);
              entityValues = Object.values(businessDevelopmentData).map(
                (value) => parseFloat(value)
              );
            } else {
              entityLabels = relatedEntities.map((e) => e.entity_name);
              entityValues = relatedEntities.map((e) => e.entity_value);
            }

            const totalValue = entityValues.reduce((sum, val) => sum + val, 0);
            try {
              setTimeout(() => {
                new Chart(document.getElementById(chartId), {
                  type: "doughnut",
                  data: {
                    labels: entityLabels,
                    datasets: [
                      {
                        data: entityValues,
                        backgroundColor: [
                          "#007bff",
                          "#28a745",
                          "#ffc107",
                          "#dc3545",
                          "#6610f2",
                          "#fd7e14",
                        ],
                      },
                    ],
                  },
                  options: {
                    plugins: {
                      legend: {
                        display: false,
                      },
                    },
                    responsive: true,
                    maintainAspectRatio: false,
                    elements: {
                      center: {
                        text: `${totalValue.toString()}`,
                        color: "#333",
                        fontStyle: "bold",
                        minFontSize: 20,
                        lineHeight: 25,
                      },
                    },
                  },
                });
              }, 100);
            } catch (error) {
              console.error(`${d.dept_name} error - ${error}`);
              alert(d.dept_name);
            }
          });

          homeHtml += `</div></div>`;
          document.getElementById("departmentContent").innerHTML = homeHtml;
        }

        breadcrumb.textContent = `Projects Dashboard > ${dept.dept_name}`;
      }

      function addStatistic(index) {
        const dept = departments[index];
        alert(`Add new statistic to: ${dept.dept_name}`);
        // You can later replace this with a modal or form
      }
      function deleteStatistic(deptId, statId) {
        if (confirm("Are you sure you want to delete this statistic?")) {
          authFetch(`/api/data/statistics/${deptId}/${statId}`, {
            method: "DELETE",
          })
            .then((res) => {
              if (!res.ok) throw new Error("Failed to delete statistic");
              location.reload();
            })
            .catch((err) => alert(err.message));
        }
      }

      let currentDeptIndex = null;

      function addStatistic(index) {
        currentDeptIndex = index;
        document.getElementById("statisticName").value = "";
        document.getElementById("entitiesContainer").innerHTML = "";
        addEntity(); // start with one entity
        const modal = new bootstrap.Modal(
          document.getElementById("addStatisticModal")
        );
        modal.show();
      }

      function addEntity() {
        const container = document.createElement("div");
        container.className = "card p-3 mb-3";
        container.innerHTML = `
                  <div class="mb-2">
                    <label class="form-label">Project Name</label>
                    <input type="text" class="form-control entity-name" required />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Project Capacity</label>
                    <input type="number" class="form-control entity-value" required />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Fields</label>
                    <div class="fieldsContainer"></div>
                    <button type="button" class="btn btn-sm btn-outline-secondary mt-1" onclick="addField(this)">+ Add Field</button>
                  </div>
                  <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentElement.remove()">Remove Entity</button>
                `;
        document.getElementById("entitiesContainer").appendChild(container);
      }

      function addField(btn) {
        const container = btn.parentElement.querySelector(".fieldsContainer");
        const div = document.createElement("div");
        div.className = "row g-2 mb-2";
        div.innerHTML = `
                  <div class="col-md-4">
                    <input type="text" class="form-control field-name" placeholder="Field Name" required />
                  </div>
                  <div class="col-md-4">
                    <input type="text" class="form-control field-value" placeholder="Field Value" required />
                  </div>
                  <div class="col-md-3">
                    <input type="text" class="form-control field-unit" placeholder="Unit" />
                  </div>
                  <div class="col-md-1">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentElement.parentElement.remove()">√ó</button>
                  </div>
                `;
        container.appendChild(div);
      }

      function saveStatistic() {
        const name = document.getElementById("statisticName").value.trim();
        if (!name) return alert("Statistic name is required");

        const entities = [];
        document
          .querySelectorAll("#entitiesContainer > .card")
          .forEach((card) => {
            const entityName = card.querySelector(".entity-name").value.trim();
            const entityValue = parseInt(
              card.querySelector(".entity-value").value
            );
            if (!entityName || isNaN(entityValue)) return;

            const fields = [];
            card.querySelectorAll(".fieldsContainer > .row").forEach((row) => {
              const fieldName = row.querySelector(".field-name").value.trim();
              const fieldValue = row.querySelector(".field-value").value.trim();
              const unit = row.querySelector(".field-unit").value.trim();
              if (fieldName && fieldValue) {
                fields.push({
                  field_name: fieldName,
                  field_value: fieldValue,
                  field_unit: unit,
                });
              }
            });

            entities.push({
              entity_name: entityName,
              entity_value: entityValue,
              fields: fields,
            });
          });

        const deptId = departments[currentDeptIndex].dept_id;

        authFetch(`/api/data/combined/newstat/${deptId}/${user_id}`, {
          method: "POST",
          body: JSON.stringify({
            statistic_name: name,
            entities: entities,
          }),
        })
          .then((res) => {
            if (!res.ok) throw new Error("Failed to save statistic");
            return res.json();
          })
          .then(() => {
            alert("Statistic added successfully.");
            bootstrap.Modal.getInstance(
              document.getElementById("addStatisticModal")
            ).hide();
            fetchDepartments();
          })
          .catch((err) => alert(err.message));
      }
      let editingDeptId = null;
      let editingStatId = null;

      function editStatistic(deptId, statId) {
        editingDeptId = deptId;
        editingStatId = statId;

        const stat = departmentStatistics[deptId].find(
          (s) => s.statistic_id === statId
        );
        if (!stat) return alert("Statistic not found");

        document.getElementById("editStatisticName").value =
          stat.statistic_name;
        const entityContainer = document.getElementById(
          "editEntitiesContainer"
        );
        entityContainer.innerHTML = "";

        const entities = departmentStatisticEntities.filter(
          (e) => e.dept_id === deptId && e.statistic_id === statId
        );
        const fields = departmentStatisticEntityFields.filter(
          (f) => f.dept_id === deptId && f.statistic_id === statId
        );

        entities.forEach((entity) => {
          const card = document.createElement("div");
          card.className = "card p-3 mb-3";
          card.innerHTML = `
                    <div class="mb-2">
                      <label class="form-label">Project Name</label>
                      <input type="text" class="form-control entity-name" value="${entity.entity_name}" />
                    </div>
                    <div class="mb-2">
                      <label class="form-label">Project Capacity</label>
                      <input type="number" class="form-control entity-value" value="${entity.entity_value}" />
                    </div>
                    <div class="mb-2">
                      <label class="form-label">Fields</label>
                      <div class="fieldsContainer"></div>
                      <button type="button" class="btn btn-sm btn-outline-secondary mt-1" onclick="addEditField(this)">+ Add Field</button>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentElement.remove()">Remove Entity</button>
                  `;

          const fieldContainer = card.querySelector(".fieldsContainer");
          const relatedFields = fields.filter(
            (f) => f.entity_id === entity.entity_id
          );
          relatedFields.forEach((f) => {
            const fieldRow = document.createElement("div");
            fieldRow.className = "row g-2 mb-2";
            fieldRow.innerHTML = `
                      <div class="col-md-4">
                        <input type="text" class="form-control field-name" placeholder="Field Name" value="${
                          f.field_name
                        }" />
                      </div>
                      <div class="col-md-4">
                        <input type="text" class="form-control field-value" placeholder="Field Value" value="${f.field_value.replace(
                          /[^0-9.]/g,
                          ""
                        )}" />
                      </div>
                      <div class="col-md-3">
                        <input type="text" class="form-control field-unit" placeholder="Unit" value="${f.field_value.replace(
                          /[0-9.]/g,
                          ""
                        )}" />
                      </div>
                      <div class="col-md-1">
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentElement.parentElement.remove()">√ó</button>
                      </div>
                    `;
            fieldContainer.appendChild(fieldRow);
          });

          entityContainer.appendChild(card);
        });

        new bootstrap.Modal(
          document.getElementById("editStatisticModal")
        ).show();
      }

      function addEditEntity() {
        const container = document.createElement("div");
        container.className = "card p-3 mb-3";
        container.innerHTML = `
                  <div class="mb-2">
                    <label class="form-label">Project Name</label>
                    <input type="text" class="form-control entity-name" />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Project Capacity</label>
                    <input type="number" class="form-control entity-value" />
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Fields</label>
                    <div class="fieldsContainer"></div>
                    <button type="button" class="btn btn-sm btn-outline-secondary mt-1" onclick="addEditField(this)">+ Add Field</button>
                  </div>
                  <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentElement.remove()">Remove Entity</button>
                `;
        document.getElementById("editEntitiesContainer").appendChild(container);
      }

      function addEditField(btn) {
        const container = btn.parentElement.querySelector(".fieldsContainer");
        const div = document.createElement("div");
        div.className = "row g-2 mb-2";
        div.innerHTML = `
                  <div class="col-md-4">
                    <input type="text" class="form-control field-name" placeholder="Field Name" />
                  </div>
                  <div class="col-md-4">
                    <input type="text" class="form-control field-value" placeholder="Field Value" />
                  </div>
                  <div class="col-md-3">
                    <input type="text" class="form-control field-unit" placeholder="Unit" />
                  </div>
                  <div class="col-md-1">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentElement.parentElement.remove()">√ó</button>
                  </div>
                `;
        container.appendChild(div);
      }

      function saveEditedStatistic() {
        const statistic_name = document
          .getElementById("editStatisticName")
          .value.trim();
        if (!statistic_name) return alert("Statistic name required");

        const entities = [];
        document
          .querySelectorAll("#editEntitiesContainer > .card")
          .forEach((card) => {
            const entity_id = card.dataset.entityId || null; // get entity_id if exists
            const entity_name = card.querySelector(".entity-name").value.trim();
            const entity_value = parseInt(
              card.querySelector(".entity-value").value.trim()
            );
            if (!entity_name || isNaN(entity_value)) return;

            const fields = [];
            card.querySelectorAll(".fieldsContainer > .row").forEach((row) => {
              const field_id = row.dataset.fieldId || null; // get field_id if exists
              const field_name = row.querySelector(".field-name").value.trim();
              const field_value = row
                .querySelector(".field-value")
                .value.trim();
              const field_unit = row.querySelector(".field-unit").value.trim();
              if (field_name && field_value) {
                fields.push({ field_id, field_name, field_value, field_unit });
              }
            });

            entities.push({ entity_id, entity_name, entity_value, fields });
          });

        authFetch(
          `/api/data/combined/newstat/${editingDeptId}/${editingStatId}`,
          {
            method: "PUT",
            headers: { "Content-Type": "application/json" }, // ADD this header
            body: JSON.stringify({ statistic_name, entities }),
          }
        )
          .then((res) => {
            if (!res.ok) throw new Error("Failed to update statistic");
            return res.json();
          })
          .then(() => {
            alert("Updated successfully");
            bootstrap.Modal.getInstance(
              document.getElementById("editStatisticModal")
            ).hide();
            fetchDepartments();
          })
          .catch((err) => alert(err.message));
      }

      function setHomeStat(deptId, statId) {
        authFetch(`/api/data/statistics/home/${deptId}/${statId}`, {
          method: "POST",
        })
          .then((res) => {
            if (!res.ok) throw new Error("Failed to set home statistic");
            return res.json();
          })
          .then(() => {
            alert("Home statistic set successfully.");
            location.reload();
          })
          .catch((err) => alert(err.message));
      }
    </script>
    <!-- Add Statistic Modal -->
    <div
      class="modal fade"
      id="addStatisticModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add New Statistic</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="statisticForm">
              <div class="mb-3">
                <label for="statisticName" class="form-label"
                  >Statistic Name</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="statisticName"
                  required
                />
              </div>
              <div id="entitiesContainer"></div>
              <button
                type="button"
                class="btn btn-outline-primary btn-sm"
                onclick="addEntity()"
              >
                + Add Entity
              </button>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="saveStatistic()"
            >
              Save
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Edit Statistic Modal -->
    <div
      class="modal fade"
      id="editStatisticModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div
        class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable"
      >
        <div class="modal-content shadow-lg border-0 rounded-4">
          <!-- Header -->
          <div class="modal-header bg-primary text-white rounded-top-4">
            <h5 class="modal-title fw-semibold">
              <i class="bi bi-bar-chart-line me-2"></i>Edit Statistic
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>

          <!-- Body -->
          <div class="modal-body px-4 py-3">
            <form id="editStatisticForm">
              <!-- Statistic Name -->
              <div class="mb-4">
                <label class="form-label fw-semibold">Statistic Name</label>
                <input
                  type="text"
                  class="form-control form-control-lg"
                  id="editStatisticName"
                  placeholder="Enter statistic name"
                />
              </div>

              <!-- Entities Section -->
              <div
                class="d-flex justify-content-between align-items-center mb-2"
              >
                <h6 class="fw-semibold mb-0">Entities</h6>
                <button
                  type="button"
                  class="btn btn-outline-primary btn-sm"
                  onclick="addEditEntity()"
                >
                  <i class="bi bi-plus-circle me-1"></i>Add Entity
                </button>
              </div>

              <div
                id="editEntitiesContainer"
                class="border rounded-3 p-3 bg-light"
              >
                <!-- Dynamic entity rows go here -->
              </div>
            </form>
          </div>

          <!-- Footer -->
          <div class="modal-footer border-0 px-4 pb-4">
            <button
              type="button"
              class="btn btn-outline-secondary px-4"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary px-4"
              onclick="saveEditedStatistic()"
            >
              <i class="bi bi-save me-1"></i>Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      function editHeadcount(index) {
        const dept = departments[index];
        currentDeptIndex = index;
        document.getElementById("editHeadcountRegular").value =
          dept.regular_count;
        document.getElementById("editHeadcountYP").value = dept.yp_count;
        document.getElementById("editHeadcountContractual").value =
          dept.contractual_count;

        const modal = new bootstrap.Modal(
          document.getElementById("editHeadcountModal")
        );
        modal.show();
      }

      function saveHeadcount() {
        const regular = parseInt(
          document.getElementById("editHeadcountRegular").value
        );
        const yp = parseInt(document.getElementById("editHeadcountYP").value);
        const contractual = parseInt(
          document.getElementById("editHeadcountContractual").value
        );

        if (isNaN(regular) || isNaN(yp) || isNaN(contractual)) {
          return alert("Please enter valid numbers for headcount.");
        }

        const dept = departments[currentDeptIndex];

        authFetch(`/api/data/departments/headcount/${dept.dept_id}`, {
          method: "PUT",
          body: JSON.stringify({
            regular_count: regular,
            yp_count: yp,
            contractual_count: contractual,
          }),
        })
          .then((res) => {
            if (!res.ok) throw new Error("Failed to update headcount");
            return res.json();
          })
          .then(() => {
            alert("Headcount updated successfully.");
            bootstrap.Modal.getInstance(
              document.getElementById("editHeadcountModal")
            ).hide();
            fetchDepartments();
          })
          .catch((err) => alert(err.message));
      }
      window.addEventListener("DOMContentLoaded", fetchDepartments);
    </script>
    <!-- Edit Headcount Modal -->
    <div
      class="modal fade"
      id="editHeadcountModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit Headcount</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form>
              <div class="mb-3">
                <label class="form-label">Regular</label>
                <input
                  type="number"
                  class="form-control"
                  id="editHeadcountRegular"
                />
              </div>
              <div class="mb-3">
                <label class="form-label">YP</label>
                <input
                  type="number"
                  class="form-control"
                  id="editHeadcountYP"
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Contractual</label>
                <input
                  type="number"
                  class="form-control"
                  id="editHeadcountContractual"
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="saveHeadcount()"
            >
              Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
