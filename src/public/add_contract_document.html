<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Add Contract Document</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    />
  </head>
  <body>
    <div class="container mt-5">
      <h1 class="mb-4">Add Contract Document</h1>
      <form id="addContractDocumentForm">
        <div class="mb-3">
          <label for="docName" class="form-label">Document Name</label>
          <input
            type="text"
            class="form-control"
            id="docName"
            name="doc_name"
            placeholder="Enter document name"
            required
          />
        </div>
        <div class="mb-3">
          <label for="docFile" class="form-label">Document Date</label>
          <input
            type="date"
            class="form-control"
            id="docDate"
            name="doc_date"
            required
          />
        <div class="mb-3">
          <label for="docFile" class="form-label">Upload Document</label>
          <small class="form-text text-muted">
            Maximum file size allowed: <strong>50 MB</strong>.
          </small>
          <input
            type="file"
            class="form-control"
            id="docFile"
            name="doc_file"
            required
          />
        </div>
        <input type="hidden" id="deptId" name="dept_id" />
        <input type="hidden" id="statisticId" name="statistic_id" />
        <input type="hidden" id="entityId" name="entity_id" />
        <input
          type="hidden"
          id="docType"
          name="doc_type"
          value="cdoc"
        />
        <button type="submit" class="btn btn-primary">Submit</button>
      </form>
    </div>

    <script>
      // Extract query parameters
      const urlParams = new URLSearchParams(window.location.search);
      const deptId = urlParams.get("dept_id");
      const statisticId = urlParams.get("statistic_id");
      const entityId = urlParams.get("entity_id");

      // Populate hidden fields
      document.getElementById("deptId").value = deptId;
      document.getElementById("statisticId").value = statisticId;
      document.getElementById("entityId").value = entityId;
      document.getElementById("docType").value = "cdoc";

      function authFetch(url, options = {}) {
        const token = localStorage.getItem("token");
        const defaultHeaders = {
          Authorization: `Bearer ${token}`,
        };

        return fetch(url, {
          ...options,
          headers: {
            ...defaultHeaders,
            ...(options.headers || {}),
          },
        }).then((res) => {
          if (res.status === 401) {
            alert("Session expired. Redirecting to login...");
            localStorage.clear();
            window.location.href = "/";
            throw new Error("Unauthorized");
          }
          return res;
        });
      }

      // Handle form submission
      document
        .getElementById("addContractDocumentForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const formData = new FormData(this);

          try {
            const response = await authFetch("/api/data/documents", {
              method: "POST",
              body: formData,
            });

            console.log(formData);
            if (!response.ok) {
              throw new Error("Failed to add Contract Document document.");
            }

            alert("Contract Document document added successfully!");
            window.location.href = `/external.html?dept_id=${deptId}&statistic_id=${statisticId}&entity_id=${entityId}`;
          } catch (err) {
            console.error(err);
            alert("Error adding Contract Document document.");
          }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
