<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Add Business Development Milestone</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .form-container {
        max-width: 700px;
        margin: 0 auto;
        margin-top: 40px;
      }
    </style>
  </head>
  <body class="p-4">
    <div class="form-container">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Add Milestone</h2>
        <a href="/business_development.html" class="btn btn-secondary">Back</a>
      </div>

      <form id="milestoneForm">
        <div class="mb-3">
          <label for="milestone_name" class="form-label">Milestone Name</label>
          <input
            type="text"
            class="form-control"
            id="milestone_name"
            required
          />
        </div>

        <div class="mb-3">
          <label for="milestone_date" class="form-label">Milestone Date</label>
          <input
            type="date"
            class="form-control"
            id="milestone_date"
            required
          />
        </div>

        <button type="submit" class="btn btn-primary">Submit</button>
      </form>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const params = new URLSearchParams(window.location.search);
        const bd_entry_id = params.get("bd_entry_id");

        if (!bd_entry_id) {
          alert("Invalid access: No Business Development Entry ID provided.");
          window.location.href = "/business_development.html";
          return;
        }

        document
          .getElementById("milestoneForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();

            const data = {
              bd_entry_id,
              milestone_name: document
                .getElementById("milestone_name")
                .value.trim(),
              milestone_date: document.getElementById("milestone_date").value,
              is_active: "true",
            };

            authFetch("/api/data/bd/milestone/add", {
              method: "POST",
              body: JSON.stringify(data),
            })
              .then((res) => {
                if (!res.ok) throw new Error("Failed to add milestone.");
                alert("Milestone added successfully.");
                window.location.href = "/business_development_external.html";
              })
              .catch((err) => {
                console.error(err);
                alert("Error adding milestone.");
              });
          });

        function authFetch(url, options = {}) {
          const token = localStorage.getItem("token");
          const defaultHeaders = {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          };

          return fetch(url, {
            ...options,
            headers: {
              ...defaultHeaders,
              ...(options.headers || {}),
            },
          }).then((res) => {
            if (res.status === 401) {
              alert("Session expired. Redirecting to login...");
              localStorage.clear();
              window.location.href = "/";
              throw new Error("Unauthorized");
            }
            return res;
          });
        }
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
