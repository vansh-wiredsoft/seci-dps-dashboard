<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>O&M Solar + Bess</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/style.css" />

    <!-- SheetJS -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
      body {
        background: #f3f6fb;
        font-family: "Segoe UI", Roboto, Arial, sans-serif;
      }

      .page-title {
        font-size: 28px;
        font-weight: 700;
        color: #0b5ed7;
      }

      .section-header {
        background: #1f4e79;
        color: #fff;
        padding: 10px;
        font-size: 20px;
        font-weight: 600;
        text-align: center;
        margin-top: 30px;
        border-radius: 4px;
      }

      table {
        background: #fff;
      }

      thead th {
        background: #e9ecef;
        text-align: center;
        vertical-align: middle;
        font-size: 13px;
      }

      tbody td {
        text-align: center;
        font-size: 13px;
      }

      .note {
        font-size: 12px;
        color: #6c757d;
      }

      .top-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      table {
        background: #ffffff;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }

      thead tr:first-child th {
        background: linear-gradient(135deg, #1f4e79, #0b5ed7);
        color: #ffffff;
        font-size: 14px;
        font-weight: 700;
        text-transform: uppercase;
        border: none;
      }

      thead tr:nth-child(2) th {
        background: #eaf1fb;
        color: #1f4e79;
        font-size: 13px;
        font-weight: 600;
        border-bottom: 2px solid #cfe2ff;
      }

      tbody td {
        font-size: 13px;
        vertical-align: middle;
        padding: 8px;
        color: #333;
      }

      /* Zebra striping */
      tbody tr:nth-child(even) {
        background-color: #f8fbff;
      }

      /* Hover effect */
      tbody tr:hover {
        background-color: #e7f1ff;
        transition: background-color 0.2s ease-in-out;
      }

      tbody td:nth-child(2),
      tbody td:nth-child(6),
      tbody td:nth-child(9) {
        font-weight: 600;
        color: #0b5ed7;
      }

      /* CUF columns */
      tbody td:nth-child(3),
      tbody td:nth-child(7),
      tbody td:nth-child(10) {
        font-weight: 600;
        color: #198754;
      }

      tbody td:nth-child(5) {
        font-style: italic;
        color: #6c757d;
      }

      #last7DaysTable thead tr:first-child th {
        background: linear-gradient(135deg, #198754, #20c997);
        color: #fff;
      }

      #last7DaysTable thead tr:nth-child(2) th {
        background: #e9f7ef;
        color: #146c43;
      }

      /* Current year columns */
      #last7DaysTable tbody td:nth-child(2),
      #last7DaysTable tbody td:nth-child(3),
      #last7DaysTable tbody td:nth-child(4),
      #last7DaysTable tbody td:nth-child(5) {
        color: #0b5ed7;
        font-weight: 500;
      }

      /* Previous year columns */
      #last7DaysTable tbody td:nth-child(6),
      #last7DaysTable tbody td:nth-child(7),
      #last7DaysTable tbody td:nth-child(8),
      #last7DaysTable {
        color: #6f42c1;
        font-weight: 500;
      }

      .section-header {
        background: linear-gradient(135deg, #1f4e79, #0b5ed7);
        color: #fff;
        padding: 12px;
        font-size: 20px;
        font-weight: 700;
        text-align: center;
        margin-top: 30px;
        border-radius: 6px;
        letter-spacing: 0.5px;
      }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>

  <body>
    <div class="container-fluid px-4 py-3">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="page-title">O&M Solar + Bess</div>

        <div class="top-actions">
          <input
            type="date"
            id="dateFilter"
            class="form-control form-control-sm"
          />
          <input
            type="file"
            id="excelUpload"
            class="form-control form-control-sm"
            accept=".xlsx,.xls"
          />
          <a
            href="add_om_solar_bess_entry.html"
            class="btn btn-success btn-sm"
            onclick="
              this.href =
                'add_om_solar_bess_entry.html' + window.location.search
            "
          >
            Add / Edit Data
          </a>
          <button
            class="btn btn-secondary btn-sm"
            onclick="window.location.href = '/home.html'"
          >
            Back to Home
          </button>
        </div>
      </div>

      <div class="section-header" id="main-heading"></div>

      <div class="table-responsive mt-3">
        <table class="table table-bordered">
          <thead>
            <tr>
              <th colspan="7">As on Date</th>
              <th colspan="4">Year Till Date</th>
              <th colspan="4">Last FY Performance</th>
            </tr>
            <tr>
              <th colspan="4">Solar</th>
              <th colspan="3">BESS</th>

              <th colspan="2">Solar</th>
              <th colspan="2">BESS</th>

              <th colspan="2">Solar</th>
              <th colspan="2">BESS</th>
            </tr>
            <tr>
              <!-- As on Date -->
              <th>GHI<br />(kWh/sq.m)</th>
              <th>Exported<br />(MU)</th>
              <th>CUF<br />(%)</th>
              <th>Peak Power<br />(MW)</th>

              <th>Net Energy Export<br />(MWh)</th>
              <th>Net Energy FED<br />(MWh)</th>
              <th>Remarks</th>

              <!-- YTD -->
              <th>Exported<br />(MU)</th>
              <th>CUF<br />(%)</th>

              <th>Net Energy Export<br />(MWh)</th>
              <th>Net Energy FED<br />(MWh)</th>

              <!-- Last FY -->
              <th>Exported<br />(MU)</th>
              <th>CUF<br />(%)</th>

              <th>Net Energy Export<br />(MWh)</th>
              <th>Net Energy FED<br />(MWh)</th>
            </tr>
          </thead>
          <tbody id="currentDateTableBody"></tbody>
        </table>

        <div class="note">
          * Data is without considering radiation correction &nbsp;&nbsp; ^ Data
          is with radiation correction
        </div>
      </div>

      <div class="section-header">Generation Data for Last 7 Days</div>

      <div class="table-responsive mt-3">
        <table class="table table-bordered" id="last7DaysTable">
          <thead>
            <tr>
              <th rowspan="2">Date</th>
              <th colspan="7">Current Year</th>
              <th colspan="6">Previous Year</th>
            </tr>
            <tr>
              <th>GHI</th>
              <th>Exported (kWh)</th>
              <th>CUF (%)</th>
              <th>Peak Power (MW)</th>
              <th>Net Export</th>
              <th>Net FED</th>
              <th>Remarks</th>

              <th>GHI</th>
              <th>Exported (kWh)</th>
              <th>CUF (%)</th>
              <th>Peak Power (MW)</th>
              <th>Net Export</th>
              <th>Net FED</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="section-header mt-4">
        Daily Generation for Last 7 Days & CUF
      </div>

      <div class="card mt-3 shadow-sm">
        <div class="card-body">
          <canvas id="dailyGenerationChart" height="120"></canvas>
        </div>
      </div>
    </div>

    <script>
      const params = new URLSearchParams(window.location.search);
      const dept_id = params.get("dept_id");
      const statistic_id = params.get("statistic_id");
      const entity_id = params.get("entity_id");
      let dailyGenerationChart = null;

      function authFetch(url, options = {}) {
        const token = localStorage.getItem("token");
        const defaultHeaders = {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        };

        return fetch(url, {
          ...options,
          headers: {
            ...defaultHeaders,
            ...(options.headers || {}),
          },
        }).then((res) => {
          if (res.status === 401) {
            alert("Session expired. Redirecting to login...");
            localStorage.clear();
            window.location.href = "/";
            throw new Error("Unauthorized");
          }
          return res;
        });
      }

      const dateInput = document.getElementById("dateFilter");
      const currentDateTbody = document.getElementById("currentDateTableBody");
      const last7DaysTbody = document.querySelector("#last7DaysTable tbody");

      dateInput.addEventListener("change", () => {
        if (!dateInput.value) return;
        fetchDataForDate(dateInput.value);
      });

      // function authFetch(url, options = {}) {
      //   const token = localStorage.getItem("token");
      //   const defaultHeaders = {
      //     "Content-Type": "application/json",
      //     Authorization: `Bearer ${token}`,
      //   };

      //   return fetch(url, {
      //     ...options,
      //     headers: {
      //       ...defaultHeaders,
      //       ...(options.headers || {}),
      //     },
      //   }).then((res) => {
      //     if (res.status === 401) {
      //       alert("Session expired. Redirecting to login...");
      //       localStorage.clear();
      //       window.location.href = "/";
      //       throw new Error("Unauthorized");
      //     }
      //     return res;
      //   });
      // }

      async function fetchProjectName() {
        try {
          GlobalLoader.show();
          const res = await authFetch(
            `/api/data/project/find/name?dept_id=${dept_id}&statistic_id=${statistic_id}&entity_id=${entity_id}`,
            {
              method: "GET",
            },
          );

          const json = await res.json();
          document.getElementById("main-heading").innerHTML =
            json.project_name || "";
        } catch (err) {
          console.error("API Error:", err);
        } finally {
          GlobalLoader.hide();
        }
      }

      async function fetchDataForDate(selectedDate) {
        try {
          GlobalLoader.show();

          const res = await authFetch(
            `/api/data/om/solar_bess/date/one?dept_id=${dept_id}&statistic_id=${statistic_id}&entity_id=${entity_id}`,
            {
              method: "POST",
              body: JSON.stringify({ requestedDate: selectedDate }),
            },
          );

          // âœ… HANDLE 204 NO CONTENT
          if (res.status === 204) {
            showNoDataState();
            return;
          }

          const json = await res.json();
          const data = json.data || {};

          bindCurrentDateTable(data.currentDate, data.lastYearMarch31);
          bindLast7DaysTable(
            data.last7Days || [],
            data.lastYearLast7Days || [],
          );
          bindDailyGenerationChart(data.last7Days || []);
        } catch (err) {
          console.error("API Error:", err);
          showNoDataState();
        } finally {
          GlobalLoader.hide();
        }
      }

      /* ===============================
       SECI 10MW Badi Sid (Top Table)
       =============================== */
      function bindCurrentDateTable(d, lastFY) {
        if (!d) {
          currentDateTbody.innerHTML = `
      <tr>
        <td colspan="14" class="text-center text-muted py-3">
          No data found
        </td>
      </tr>
    `;
          return;
        }

        currentDateTbody.innerHTML = `
    <tr>
      <!-- As on Date â€“ Solar -->
      <td>${d.radiation?.toFixed(2) ?? "-"}</td>
      <td>${d.generation ? (d.generation / 1e6).toFixed(6) : "-"}</td>
      <td>${d.daily_cuf_worc?.toFixed(2) ?? "-"}%</td>
      <td>${d.peak_power?.toFixed(3) ?? "-"}</td>

      <!-- As on Date â€“ BESS -->
      <td>${d.bess_export?.toFixed(3) ?? "-"}</td>
      <td>${d.bess_import?.toFixed(3) ?? "-"}</td>
      <td>${d.remarks ?? "-"}</td>

      <!-- YTD -->
      <td>${d.cumulative_generation ? (d.cumulative_generation / 1e6).toFixed(6) : "-"}</td>
      <td>${d.cuf_till_date?.toFixed(2) ?? "-"}%</td>

      <td>${d.cumulative_bess_export?.toFixed(3) ?? "-"}</td>
      <td>${d.cumulative_bess_import?.toFixed(3) ?? "-"}</td>

      <!-- Last FY -->
      <td>${lastFY ? (lastFY.generation / 1e6).toFixed(6) : "-"}</td>
      <td>${lastFY ? lastFY.daily_cuf_worc?.toFixed(2) + "%" : "-"}</td>

      <td>${lastFY ? lastFY.bess_export?.toFixed(3) : "-"}</td>
      <td>${lastFY ? lastFY.bess_import?.toFixed(3) : "-"}</td>
    </tr>
  `;
      }

      /* =========================================
       Generation Data â€“ Last 7 Days (Both Years)
       ========================================= */
      function bindLast7DaysTable(currentYear = [], previousYear = []) {
        last7DaysTbody.innerHTML = "";

        if (!currentYear.length && !previousYear.length) {
          last7DaysTbody.innerHTML = `
      <tr>
        <td colspan="14" class="text-center text-muted py-3">
          No data found
        </td>
      </tr>
    `;
          return;
        }

        for (
          let i = 0;
          i < Math.max(currentYear.length, previousYear.length);
          i++
        ) {
          const cur = currentYear[i];
          const prev = previousYear[i];

          last7DaysTbody.innerHTML += `
      <tr>
        <td>${formatDate(cur?.date || prev?.date)}</td>

        <!-- 2026 -->
        <td>${cur?.radiation?.toFixed(2) ?? "-"}</td>
        <td>${cur?.generation?.toFixed(2) ?? "-"}</td>
        <td>${cur ? cur.daily_cuf_worc.toFixed(2) : "-"}%</td>
        <td>${cur?.peak_power?.toFixed(3) ?? "-"}</td>
        <td>${cur?.bess_export?.toFixed(3) ?? "-"}</td>
        <td>${cur?.bess_import?.toFixed(3) ?? "-"}</td>
        <td>${cur?.remarks ?? "-"}</td>

        <!-- 2025 -->
        <td>${prev?.radiation?.toFixed(2) ?? "-"}</td>
        <td>${prev?.generation?.toFixed(2) ?? "-"}</td>
        <td>${prev ? prev.daily_cuf_worc.toFixed(2) : "-"}%</td>
        <td>${prev?.peak_power?.toFixed(3) ?? "-"}</td>
        <td>${prev?.bess_export?.toFixed(3) ?? "-"}</td>
        <td>${prev?.bess_import?.toFixed(3) ?? "-"}</td>
      </tr>
    `;
        }
      }

      function showNoDataState() {
        // Top table
        currentDateTbody.innerHTML = `
    <tr>
      <td colspan="14" class="text-center text-muted py-3">
        No data found for selected date
      </td>
    </tr>
  `;

        // Last 7 days table
        last7DaysTbody.innerHTML = `
    <tr>
      <td colspan="14" class="text-center text-muted py-3">
        No data found
      </td>
    </tr>
  `;

        // Destroy chart
        if (dailyGenerationChart) {
          dailyGenerationChart.destroy();
          dailyGenerationChart = null;
        }
      }

      function formatDate(dateStr) {
        const d = new Date(dateStr);
        return d.toLocaleDateString("en-GB", {
          day: "2-digit",
          month: "short",
        });
      }

      function fileAuthFetch(url, options = {}) {
        const token = localStorage.getItem("token");
        const defaultHeaders = {
          Authorization: `Bearer ${token}`,
        };

        return fetch(url, {
          ...options,
          headers: {
            ...defaultHeaders,
            ...(options.headers || {}),
          },
        }).then((res) => {
          if (res.status === 401) {
            alert("Session expired. Redirecting to login...");
            localStorage.clear();
            window.location.href = "/";
            throw new Error("Unauthorized");
          }
          return res;
        });
      }

      function bindDailyGenerationChart(last7Days = []) {
        if (!last7Days.length) {
          if (dailyGenerationChart) {
            dailyGenerationChart.destroy();
            dailyGenerationChart = null;
          }
          return;
        }

        const labels = last7Days.map((d) =>
          new Date(d.date).toLocaleDateString("en-GB", {
            day: "2-digit",
            month: "short",
          }),
        );

        const generationData = last7Days.map((d) => d.generation);
        const cufData = last7Days.map((d) => d.daily_cuf_worc);
        const remarksData = last7Days.map((d) => d.remarks || "No remarks");

        const ctx = document
          .getElementById("dailyGenerationChart")
          .getContext("2d");

        // ðŸ” Destroy previous chart
        if (dailyGenerationChart) {
          dailyGenerationChart.destroy();
        }

        dailyGenerationChart = new Chart(ctx, {
          data: {
            labels,
            datasets: [
              {
                type: "bar",
                label: "Generation (kWh)",
                data: generationData,
                yAxisID: "yGeneration",
              },
              {
                type: "line",
                label: "CUF (%)",
                data: cufData,
                yAxisID: "yCUF",
                tension: 0.3,
                pointRadius: 4,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              tooltip: {
                mode: "index",
                intersect: false,
                callbacks: {
                  afterBody: function (tooltipItems) {
                    const index = tooltipItems[0].dataIndex;
                    return `Remarks: ${remarksData[index]}`;
                  },
                },
              },
              legend: {
                position: "top",
              },
            },
            scales: {
              yGeneration: {
                type: "linear",
                position: "left",
                title: {
                  display: true,
                  text: "Generation (kWh)",
                },
              },
              yCUF: {
                type: "linear",
                position: "right",
                title: {
                  display: true,
                  text: "CUF (%)",
                },
                grid: {
                  drawOnChartArea: false,
                },
              },
            },
          },
        });
      }

      document
        .getElementById("excelUpload")
        .addEventListener("change", async function (e) {
          const file = e.target.files[0];
          if (!file) return;

          // âœ… Validate extension
          if (!file.name.match(/\.(xlsx|xls)$/i)) {
            alert("Please upload a valid Excel file (.xls or .xlsx)");
            e.target.value = "";
            return;
          }

          const formData = new FormData();
          formData.append("excelFile", file); // ðŸ”¥ must match multer field name

          try {
            GlobalLoader.show();
            const res = await fileAuthFetch(
              `/api/data/om/upload/solar_bess?dept_id=${dept_id}&statistic_id=${statistic_id}&entity_id=${entity_id}`,
              {
                method: "POST",
                body: formData,
              },
            );
            const { message, summary } = await res.json();

            if (!res.ok) {
              throw new Error(message || "Excel upload failed");
            }

            let alertMsg = `âœ… ${message}\n\n`;

            if (summary) {
              alertMsg +=
                `ðŸ“Š Upload Summary:\n` +
                `â€¢ Total Rows: ${summary.totalRows ?? 0}\n` +
                `â€¢ Inserted: ${summary.inserted ?? 0}\n` +
                `â€¢ Updated: ${summary.updated ?? 0}\n` +
                `â€¢ Skipped: ${summary.skipped ?? 0}`;
            }

            alert(alertMsg);

            const selectedDate = document.getElementById("dateFilter").value;
            if (selectedDate) {
              fetchDataForDate(selectedDate);
            }
          } catch (err) {
            console.error("Excel upload error:", err);
            alert(err.message || "Failed to upload Excel file");
          } finally {
            e.target.value = "";
            GlobalLoader.hide();
          }
        });

      window.addEventListener("DOMContentLoaded", () => {
        // Set default date = today - 1
        const today = new Date();
        today.setDate(today.getDate() - 1);

        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, "0");
        const dd = String(today.getDate()).padStart(2, "0");

        const defaultDate = `${yyyy}-${mm}-${dd}`;

        dateInput.value = defaultDate;

        // Auto-fetch data for default date
        fetchDataForDate(defaultDate);
        fetchProjectName();
      });
    </script>
    <script src="js/main.js"></script>
  </body>
</html>
