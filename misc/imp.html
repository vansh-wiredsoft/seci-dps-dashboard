<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>User-Department Mapping</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container mt-5">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h4>User-Department Mapping Editor</h4>
        <button
          class="btn btn-outline-primary"
          onclick="window.location.href='/home.html'"
        >
          Back to Home
        </button>
      </div>

      <div id="mappingSection">
        <div id="mappingsTableContainer">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>User</th>
                <th>Departments</th>
              </tr>
            </thead>
            <tbody id="mappingsTableBody">
              <tr>
                <td colspan="2" class="text-center">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>
        <button
          id="saveBtn"
          class="btn btn-success mt-3"
          onclick="saveMappings()"
        >
          Save Changes
        </button>
      </div>
    </div>

    <script>
      const originalMappings = {};

      function authFetch(url, options = {}) {
        const token = localStorage.getItem("token");
        return fetch(url, {
          ...options,
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
            ...(options.headers || {}),
          },
        }).then((res) => {
          if (res.status === 401) {
            alert("Session expired. Redirecting to login...");
            localStorage.clear();
            window.location.href = "/";
            throw new Error("Unauthorized");
          }
          return res.json();
        });
      }

      function loadMappings() {
        const tableBody = document.getElementById("mappingsTableBody");
        tableBody.innerHTML = `<tr><td colspan="2" class="text-center">Loading...</td></tr>`;

        Promise.all([
          authFetch("/api/data/mapping/all"),
          authFetch("/api/auth/users"),
          authFetch("/api/data/departments"),
        ])
          .then(([mappingData, users, departments]) => {
            tableBody.innerHTML = "";

            users.forEach((user) => {
              const userDepts = mappingData[user.name] || [];
              originalMappings[user.user_id] = new Set(
                departments
                  .filter((d) => userDepts.includes(d.dept_name))
                  .map((d) => d.dept_id)
              );

              const deptCheckboxes = departments
                .map((dept) => {
                  const isChecked = userDepts.includes(dept.dept_name);
                  return `
                  <div class="form-check form-check-inline">
                    <input class="form-check-input mapping-checkbox" type="checkbox"
                      data-user-id="${user.user_id}"
                      data-dept-id="${dept.dept_id}"
                      data-dept-name="${dept.dept_name}"
                      data-user-name="${user.name}"
                      ${isChecked ? "checked" : ""}>
                    <label class="form-check-label">${dept.dept_name}</label>
                  </div>
                `;
                })
                .join("");

              const row = document.createElement("tr");
              row.innerHTML = `
              <td>${user.name}</td>
              <td>${deptCheckboxes}</td>
            `;
              tableBody.appendChild(row);
            });
          })
          .catch((err) => {
            console.error("Error loading mappings", err);
            tableBody.innerHTML = `<tr><td colspan="2" class="text-danger text-center">Error loading mappings</td></tr>`;
          });
      }

      function saveMappings() {
        const checkboxes = document.querySelectorAll(".mapping-checkbox");
        const currentMap = {};

        checkboxes.forEach((cb) => {
          const userId = cb.dataset.userId;
          const deptId = cb.dataset.deptId;
          const isChecked = cb.checked;

          if (!currentMap[userId]) currentMap[userId] = new Set();
          if (isChecked) currentMap[userId].add(deptId);
        });

        const changes = [];

        for (const userId in currentMap) {
          const currentDepts = currentMap[userId];
          const originalDepts = originalMappings[userId] || new Set();

          // Additions
          currentDepts.forEach((deptId) => {
            if (!originalDepts.has(deptId)) {
              changes.push([userId, deptId, "add"]);
            }
          });

          // Removals
          originalDepts.forEach((deptId) => {
            if (!currentDepts.has(deptId)) {
              changes.push([userId, deptId, "remove"]);
            }
          });
        }

        // Also check for users that were removed from all departments
        for (const userId in originalMappings) {
          if (!currentMap[userId]) {
            originalMappings[userId].forEach((deptId) => {
              changes.push([userId, deptId, "remove"]);
            });
          }
        }

        if (changes.length === 0) {
          alert("No changes to save.");
          return;
        }

        authFetch("/api/data/mapping/manage", {
          method: "POST",
          body: JSON.stringify({ mappings: changes }),
        })
          .then(() => {
            alert("Mappings updated successfully.");
            loadMappings(); // Reload for freshness
          })
          .catch((err) => {
            console.error("Error saving mappings:", err);
            alert("Failed to save changes.");
          });
      }

      document.addEventListener("DOMContentLoaded", loadMappings);
    </script>
  </body>
</html>
